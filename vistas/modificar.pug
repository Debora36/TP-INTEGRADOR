doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title Modificar
    link(rel="icon", href="#", type="image/png")
    link(rel="stylesheet", href="/style.css")
    link(rel="stylesheet", href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css")
    link(href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css", rel="stylesheet")
    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js")

  body
    .navbar.navbar-expand-sm.bg-info.navbar-dark.p-3
      .container-fluid
        .navbar-brand
          h4.display-6.px-4.text-white Sistema de Información Hospitalaria
        .d-flex.ms-auto.align-items-center
          span.text-white.me-2= usuario.nombre_usuario
          a(href="/logout", title="Cerrar sesión")
            i.fas.fa-sign-out-alt.text-white.mt-4

    .container
      h2.mt-4.mb-3.text-center Listado de Internaciones

      input.form-control.mb-3(type="text", id="filtro", placeholder="Filtrar por DNI, nombre o ala...")

      table.table.table-striped.table-bordered#tablaInternaciones
        thead
          tr.text-center
            th DNI Paciente
            th Nombre Paciente
            th Ala
            th Habitación
            th Fecha de Admisión
            th Acciones
        - var internaciones = typeof internaciones !== 'undefined' ? internaciones : []
        tbody
          each internacion in internaciones
            - const dni = internacion.paciente && internacion.paciente.DNI ? internacion.paciente.DNI : '';
            - const nombre = internacion.paciente && internacion.paciente.Nombre ? internacion.paciente.Nombre : '';
            - const ala = internacion.habitacion && internacion.habitacion.ID_ala_hospital.nombre_ala ? internacion.habitacion.ID_ala_hospital.nombre_ala : '';
            - const habitacion = internacion.habitacion && internacion.habitacion.Numero ? internacion.habitacion.Numero : '';
            - const fecha = internacion.FechaIngreso ? internacion.FechaIngreso.toISOString().split('T')[0] : '';

            tr(data-id=internacion.ID, data-dni=dni, data-nombre=nombre, data-ala=ala)
              td
                input.form-control-plaintext.editable(type="text", value=dni, readonly)
              td
                input.form-control-plaintext.editable(type="text", value=nombre, readonly)
              td
                input.form-control-plaintext.editable(type="text", value=ala, readonly)
              td
                input.form-control-plaintext.editable(type="text", value=habitacion, readonly)
              td
                input.form-control-plaintext.editable(type="date", value=fecha, readonly)
              td.text-center
                button.btn.btn-warning.btn-sm.mx-1.editar(type="button") Modificar
                button.btn.btn-danger.btn-sm.mx-1.eliminar(type="button") Eliminar

  script.
    document.addEventListener("DOMContentLoaded", function () {
      const filtro = document.getElementById('filtro');
      filtro.addEventListener('input', () => {
        console.log('Filtro activado');
        const valor = filtro.value.toLowerCase().trim();
        document.querySelectorAll('#tablaInternaciones tbody tr').forEach(tr => {
          const dni = tr.dataset.dni.toLowerCase();
          const nombre = tr.dataset.nombre.toLowerCase();
          const ala = tr.dataset.ala.toLowerCase();
          const combinado = `${dni} ${nombre} ${ala}`;
          tr.style.display = combinado.includes(valor) ? '' : 'none';
        });
      });

      document.querySelectorAll('.editar').forEach(boton => {
        boton.addEventListener('click', () => {
          const fila = boton.closest('tr');
          const inputs = fila.querySelectorAll('.editable');
          const editando = inputs[0].readOnly === false;
          if (!editando) {
            inputs.forEach(i => i.readOnly = false);
            boton.textContent = 'Guardar';
            boton.classList.remove('btn-warning');
            boton.classList.add('btn-success');
          } else {
            const datos = {
              dni: inputs[0].value,
              nombre: inputs[1].value,
              ala: inputs[2].value,
              habitacion: inputs[3].value,
              fecha: inputs[4].value
            };
            fetch(`/internacion/${fila.dataset.id}/editar`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(datos)
            }).then(res => {
              if (res.ok) {
                alert('Internación actualizada');
              } else {
                alert('Error al actualizar');
              }
            });
            inputs.forEach(i => i.readOnly = true);
            boton.textContent = 'Modificar';
            boton.classList.remove('btn-success');
            boton.classList.add('btn-warning');
          }
        });
      });

      document.querySelectorAll('.eliminar').forEach(boton => {
        boton.addEventListener('click', () => {
          const fila = boton.closest('tr');
          if (confirm('¿Desea eliminar esta internación?')) {
            fetch(`/internacion/${fila.dataset.id}/eliminar`, {
              method: 'DELETE'
            }).then(res => {
              if (res.ok) {
                fila.remove();
              } else {
                alert('Error al eliminar');
              }
            });
          }
        });
      });
    });
